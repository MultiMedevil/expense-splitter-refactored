<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense Splitter</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/user-cards.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body>
  <div id="app">
    <div class="sidebar-layout">
      <nav class="sidebar">
        <div class="sidebar-title">Expense Splitter</div>
        <button :class="{active: currentView === 'users'}" @click="currentView = 'users'">Benutzer</button>
        <button :class="{active: currentView === 'expenses'}" @click="currentView = 'expenses'">Ausgaben</button>
        <button :class="{active: currentView === 'trips'}" @click="currentView = 'trips'">Reisen</button>
        <button :class="{active: currentView === 'settings'}" @click="currentView = 'settings'">Einstellungen</button>
      </nav>
      <main class="main-content">
        <section v-if="currentView === 'users'" class="users-section">
          <div class="section-header">
            <h1 style="margin: 0; color: #333;">Benutzerverwaltung</h1>
            <button @click="openUserModal()" class="add-user-btn">
              <span style="font-size: 1.2em; margin-right: 0.5em;">‚ûï</span>
              Neuer Benutzer
            </button>
          </div>
          
          <div v-if="users.length === 0" class="empty-state">
            <p style="text-align: center; color: #666; margin: 3em 0;">Noch keine Benutzer vorhanden.</p>
          </div>
          
          <div v-else class="users-grid">
            <div v-for="(user, idx) in users" 
                 :key="user.name" 
                 class="user-card"
                 @click="openUserModal(idx)">
              
              <div class="user-card-header">
                <div class="user-avatar">
                  {{ user.name.charAt(0).toUpperCase() }}
                </div>
                <h3 class="user-name-card">
                  {{ user.name }}
                </h3>
              </div>
              
              <div class="user-card-body">
                <div v-if="user.tags && user.tags.length" class="user-tags">
                  <span v-for="tag in (user.tags ? user.tags.slice().sort() : [])" 
                        :key="tag" 
                        :class="['tag-badge', 'tag-badge--' + tag.replace(/\s+/g, '-').toLowerCase()]">
                    {{ tag }}
                  </span>
                </div>
                <div v-else class="no-tags">
                  <span style="color: #999; font-size: 0.9em;">Keine Tags zugewiesen</span>
                </div>
              </div>
              
              <div class="user-card-footer">
                <div class="user-stats">
                  <div class="stat-item">
                    <span class="stat-value">{{ getUserExpenseCount(user.name) }}</span>
                    <span class="stat-label">Ausgaben</span>
                  </div>
                  <div class="stat-item">
                    <span class="stat-value">{{ getUserTotalAmount(user.name).toFixed(2) }} ‚Ç¨</span>
                    <span class="stat-label">Gesamt</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- User Modal -->
          <div v-if="showUserModal" class="modal-overlay" @click="closeUserModal">
            <div class="modal-dialog" style="max-width:600px;" @click.stop>
              <h2 style="text-align:center; margin-bottom:1.5em;">
                <span v-if="editingUserIdx === null">üë§ Neuer Benutzer</span>
                <span v-else>üë§ {{ users[editingUserIdx].name }}</span>
              </h2>
              
              <!-- Name Input nur bei neuem Benutzer -->
              <div v-if="editingUserIdx === null" style="margin-bottom:1.5em;">
                <label style="display:block; margin-bottom:0.5em; font-weight:600; color:#333;">Name</label>
                <input v-model="newUserName" 
                       placeholder="Name des Benutzers" 
                       style="width:100%; padding:0.8em; border:1px solid #e0e0e0; border-radius:8px; font-size:1em;" />
                <span v-if="error" style="color:#f44336; font-size:0.9em; margin-top:0.5em; display:block;">{{ error }}</span>
              </div>
              
              <!-- Tags -->
              <div style="margin-bottom:1.5em;">
                <h3 style="margin-bottom:0.8em; color:#333;">üè∑Ô∏è Tags</h3>
                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(120px, 1fr)); gap:0.8em;">
                  <label v-for="tag in availableUserTags" :key="tag" 
                         style="display:flex; align-items:center; padding:0.6em; background:#f8f9fa; border-radius:6px; cursor:pointer; transition:all 0.2s;"
                         :style="getUserTagStyle(tag)">
                    <input type="checkbox" 
                           :value="tag" 
                           :checked="(editingUserIdx !== null && users[editingUserIdx].tags) ? users[editingUserIdx].tags.includes(tag) : selectedUserTags.includes(tag)" 
                           @change="toggleUserTag(tag)"
                           style="margin-right:0.5em; cursor:pointer;" />
                    <span style="font-weight:500;">{{ tag }}</span>
                  </label>
                </div>
              </div>
              
              <!-- Hierarchische Statistiken nur bei bestehendem Benutzer -->
              <div v-if="editingUserIdx !== null" style="margin-bottom:1.5em; padding:1em; background:#f5f5f5; border-radius:8px;">
                <h3 style="margin-bottom:0.8em; color:#333;">üìä Detaillierte Statistik</h3>
                
                <!-- Gesamtbetrag -->
                <div style="text-align:center; margin-bottom:1em;">
                  <div style="font-size:1.5em; font-weight:bold; color:#2196f3;">{{ getUserTotalAmount(users[editingUserIdx].name).toFixed(2) }} ‚Ç¨</div>
                  <div style="color:#666; font-size:0.9em;">Gesamtbetrag</div>
                </div>

                <!-- Erste Ebene: √úbersicht pro Ausgabe -->
                <div style="display:grid; gap:0.8em;">
                  
                  <!-- Sammelausgaben -->
                  <div v-if="getUserDetailedStats(users[editingUserIdx].name).expenses.items.length > 0" 
                       style="padding:0.8em; background:white; border-radius:6px; border-left:4px solid #4caf50;">
                    <div style="font-weight:bold; color:#4caf50;">üì¶ Sammelausgaben</div>
                    <div style="font-size:0.9em; color:#666; margin-bottom:0.5em;">{{ getUserDetailedStats(users[editingUserIdx].name).expenses.items.length }} Ausgaben</div>
                    
                    <!-- Auflistung der Sammelausgaben -->
                    <div style="display:grid; gap:0.4em; margin-top:0.5em;">
                      <div v-for="expense in getUserDetailedStats(users[editingUserIdx].name).expenses.items" 
                           @click="showExpenseDetails(expense.id, users[editingUserIdx].name)"
                           style="display:flex; justify-content:space-between; align-items:center; padding:0.5em; background:#f8f9fa; border-radius:4px; cursor:pointer; transition:background 0.2s;"
                           @mouseover="$event.target.style.background='#e9ecef'"
                           @mouseout="$event.target.style.background='#f8f9fa'">
                        <span style="font-size:0.9em;">{{ expense.name }}</span>
                        <span style="font-weight:bold; color:#4caf50;">{{ expense.userAmount.toFixed(2) }} ‚Ç¨</span>
                      </div>
                    </div>
                  </div>

                  <!-- Events -->
                  <div v-if="getUserDetailedStats(users[editingUserIdx].name).events.items.length > 0" 
                       style="padding:0.8em; background:white; border-radius:6px; border-left:4px solid #ff9800;">
                    <div style="font-weight:bold; color:#ff9800;">üéâ Events</div>
                    <div style="font-size:0.9em; color:#666; margin-bottom:0.5em;">{{ getUserDetailedStats(users[editingUserIdx].name).events.items.length }} Events</div>
                    
                    <!-- Auflistung der Events -->
                    <div style="display:grid; gap:0.4em; margin-top:0.5em;">
                      <div v-for="event in getUserDetailedStats(users[editingUserIdx].name).events.items" 
                           @click="showEventDetails(event.id, users[editingUserIdx].name)"
                           style="display:flex; justify-content:space-between; align-items:center; padding:0.5em; background:#f8f9fa; border-radius:4px; cursor:pointer; transition:background 0.2s;"
                           @mouseover="$event.target.style.background='#e9ecef'"
                           @mouseout="$event.target.style.background='#f8f9fa'">
                        <span style="font-size:0.9em;">{{ event.name }}</span>
                        <span style="font-weight:bold; color:#ff9800;">{{ event.userAmount.toFixed(2) }} ‚Ç¨</span>
                      </div>
                    </div>
                  </div>

                  <!-- √úbernachtungen -->
                  <div v-if="getUserDetailedStats(users[editingUserIdx].name).accommodations.items.length > 0" 
                       style="padding:0.8em; background:white; border-radius:6px; border-left:4px solid #9c27b0;">
                    <div style="font-weight:bold; color:#9c27b0;">üè® √úbernachtungen</div>
                    <div style="font-size:0.9em; color:#666; margin-bottom:0.5em;">{{ getUserDetailedStats(users[editingUserIdx].name).accommodations.items.length }} √úbernachtungen</div>
                    
                    <!-- Auflistung der √úbernachtungen -->
                    <div style="display:grid; gap:0.4em; margin-top:0.5em;">
                      <div v-for="accommodation in getUserDetailedStats(users[editingUserIdx].name).accommodations.items" 
                           @click="showAccommodationDetails(accommodation.id, users[editingUserIdx].name)"
                           style="display:flex; justify-content:space-between; align-items:center; padding:0.5em; background:#f8f9fa; border-radius:4px; cursor:pointer; transition:background 0.2s;"
                           @mouseover="$event.target.style.background='#e9ecef'"
                           @mouseout="$event.target.style.background='#f8f9fa'">
                        <span style="font-size:0.9em;">{{ accommodation.name }}</span>
                        <span style="font-weight:bold; color:#9c27b0;">{{ accommodation.userAmount.toFixed(2) }} ‚Ç¨</span>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
              
              <!-- Zweite Ebene: Detail-Ansicht -->
              <div v-if="selectedDetailItem && selectedDetailItem.user === users[editingUserIdx].name" 
                   :key="'detail-' + selectedDetailItem.key"
                   style="margin-top: 1em; padding: 1em; background: white; border-radius: 6px; border: 1px solid #ddd;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.8em;">
                  <h4 style="margin:0; color:#333;">{{ selectedDetailItem.name }}</h4>
                  <button @click="closeDetailView" 
                          style="background:none; border:none; font-size:1.2em; cursor:pointer; color:#666;">√ó</button>
                </div>
                
                <!-- Detaillierte Aufschl√ºsselung -->
                <div style="display:grid; gap:0.5em;">
                  <div v-for="(item, index) in selectedDetailItem.items" :key="'item-' + index" 
                       style="display:flex; justify-content:space-between; align-items:center; padding:0.5em; background:#f8f9fa; border-radius:4px;">
                    <span style="font-size:0.9em;">{{ item.name }}</span>
                    <span style="font-weight:bold; color:#333;">{{ item.userShare.toFixed(2) }} ‚Ç¨</span>
                  </div>
                </div>
                
                <div style="margin-top:0.8em; padding-top:0.8em; border-top:1px solid #eee; text-align:right;">
                  <strong style="color:#333;">Gesamt: {{ selectedDetailItem.total.toFixed(2) }} ‚Ç¨</strong>
                </div>
              </div>
              
              <!-- Buttons -->
              <div style="display:flex; justify-content:center; gap:1em; margin-top:2em;">
                <button v-if="editingUserIdx === null" 
                        @click="saveNewUser" 
                        style="padding:0.8em 2.5em; background:#4caf50; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; font-size:1em;">
                  Erstellen
                </button>
                <button v-else 
                        @click="updateUser" 
                        style="padding:0.8em 2.5em; background:#4caf50; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; font-size:1em;">
                  Speichern
                </button>
                <button v-if="editingUserIdx !== null" 
                        @click="confirmDeleteUser" 
                        style="padding:0.8em 2.5em; background:#f44336; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; font-size:1em;">
                  L√∂schen
                </button>
                <button @click="closeUserModal" 
                        style="padding:0.8em 2.5em; background:#9e9e9e; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; font-size:1em;">
                  Abbrechen
                </button>
              </div>
            </div>
          </div>
          
          <!-- User L√∂schbest√§tigung Modal -->
          <div v-if="showUserDeleteConfirm" class="modal-overlay" @click="cancelUserDelete">
            <div class="modal-dialog" style="max-width:450px;" @click.stop>
              <h2 style="text-align:center; margin-bottom:1.5em;">‚ö†Ô∏è Benutzer l√∂schen?</h2>
              <p v-if="editingUserIdx !== null" style="text-align:center; margin-bottom:2em; color:#555; line-height:1.5;">
                M√∂chtest du den Benutzer<br/>
                <strong style="color:#333;">{{ users[editingUserIdx].name }}</strong><br/>
                wirklich l√∂schen?
              </p>
              <div style="display:flex; justify-content:center; gap:1em;">
                <button @click="deleteUserConfirmed" 
                        style="padding:0.8em 2em; background:#f44336; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">
                  Ja, l√∂schen
                </button>
                <button @click="cancelUserDelete" 
                        style="padding:0.8em 2em; background:#9e9e9e; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">
                  Abbrechen
                </button>
              </div>
            </div>
          </div>
        </section>

        <section v-if="currentView === 'expenses'">
          <h1>Ausgaben</h1>
          <div class="action-buttons-container">
            <button @click="openExpenseModal" class="action-btn action-btn--primary">
              <span class="action-btn__icon">üõí</span>
              <span>Einkauf</span>
            </button>
            <button @click="openEventModal" class="action-btn action-btn--secondary">
              <span class="action-btn__icon">üéâ</span>
              <span>Event</span>
            </button>
            <button @click="openAccommodationModal" class="action-btn action-btn--tertiary">
              <span class="action-btn__icon">üè®</span>
              <span>Unterkunft</span>
            </button>
          </div>
          
          <!-- AUSGABEN-LISTE MIT DROPDOWN-SYSTEM -->
          <div v-if="validExpenses.length" class="expenses-list">
            <div v-for="expense in validExpenses" :key="expense.id" class="expense-item">
              
              <!-- HAUPT-ZEILE -->
              <div class="expense-row" 
                   @click="toggleExpenseDropdown(expense.id)" 
                   :class="{'expense-row-expanded': expandedExpenseIds.includes(expense.id)}">
                   
                <div class="expense-info">
                  <div class="expense-header">
                    <span class="expense-name">
                      <span v-if="expense.type === 'event'" class="badge badge--event">Event</span>
                      <span v-else-if="expense.type === 'accommodation'" class="badge badge--accommodation">üè®</span>
                      {{ expense.name }}
                      <span v-if="expense.items && expense.items.some(item => !item.tag)" class="missing-tag-icon" title="Mindestens ein Einzelposten ohne Tag">‚ö†Ô∏è</span>
                    </span>
                    <span class="expense-toggle">
                      <span v-if="expandedExpenseIds.includes(expense.id)">‚ñ≤</span>
                      <span v-else>‚ñº</span>
                    </span>
                  </div>
                  
                  <div class="expense-meta">
                    <span class="expense-price">
                      <span v-if="expense.type === 'event'">
                        {{ (Number(expense.price) + ((expense.extras || []).reduce((sum, ex) => sum + (Number(ex.price) || 0), 0))).toFixed(2) }} ‚Ç¨
                      </span>
                      <span v-else-if="expense.type === 'accommodation'">
                        {{ getExpenseTotal(expense).toFixed(2) }} ‚Ç¨
                      </span>
                      <span v-else>
                        {{ getExpenseTotal(expense).toFixed(2) }} ‚Ç¨
                      </span>
                    </span>
                    <span v-if="expense.type === 'event'" class="expense-participants">
                      {{ expense.participants.length }} Teilnehmer
                    </span>
                    <span v-else-if="expense.type === 'accommodation'" class="expense-participants">
                      {{ expense.participants.length }} {{ expense.participants.length === 1 ? 'Person' : 'Personen' }}
                    </span>
                  </div>
                </div>
                
                <div class="expense-actions">
                  <button class="expense-action-btn" @click.stop="editExpense(expense.id)">Bearbeiten</button>
                  <button class="expense-action-btn delete" @click.stop="confirmDeleteExpense(expense.id)">L√∂schen</button>
                </div>
              </div>
              
              <!-- DROPDOWN-DETAILS -->
              <div v-if="expandedExpenseIds.includes(expense.id)" class="expense-dropdown">
                
                <!-- Details f√ºr Events -->
                <div v-if="expense.type === 'event'" class="dropdown-content">
                  <div class="detail-section">
                    <h4>üë• Teilnehmer</h4>
                    <p v-if="expense.participants && expense.participants.length" class="participants-list">
                      {{ expense.participants.join(', ') }}
                    </p>
                    <p v-else class="no-data">Keine Teilnehmer erfasst</p>
                  </div>
                  
                  <div v-if="expense.extras && expense.extras.length" class="detail-section">
                    <h4>üí∞ Extra Ausgaben</h4>
                    <div class="extras-list">
                      <div v-for="(extra, extraIdx) in expense.extras" :key="extraIdx" class="extra-item">
                        <span class="extra-label">{{ extra.label }}</span>
                        <span class="extra-price">{{ Number(extra.price).toFixed(2) }} ‚Ç¨</span>
                        <span v-if="extra.participants && extra.participants.length" class="extra-participants">
                          ({{ extra.participants.join(', ') }})
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Details f√ºr √úbernachtungen -->
                <div v-else-if="expense.type === 'accommodation'" class="dropdown-content">
                  <div class="detail-section">
                    <h4>üè® √úbernachtung: {{ expense.pricePerNight }} ‚Ç¨ pro Nacht</h4>
                    <div class="participants-list" style="margin-bottom:1em;">
                      <div v-for="participant in expense.participants" :key="participant.name" style="margin-bottom:0.3em;">
                        {{ participant.name }}: {{ participant.nights }} {{ participant.nights === 1 ? 'Nacht' : 'N√§chte' }} = {{ (expense.pricePerNight * participant.nights).toFixed(2) }} ‚Ç¨
                      </div>
                    </div>
                    <div v-if="expense.extras && expense.extras.length" class="detail-section">
                      <h4>üéØ Extras</h4>
                      <div class="extras-list">
                        <div v-for="(extra, extraIdx) in expense.extras" :key="extraIdx" class="extra-item">
                          <span class="extra-label">{{ extra.label }}</span>
                          <span class="extra-price">{{ Number(extra.price).toFixed(2) }} ‚Ç¨</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Details f√ºr Sammelausgaben -->
                <div v-else class="dropdown-content">
                  <div class="detail-section">
                    <h4>üìã Einzelposten</h4>
                    <div v-if="expense.items && expense.items.length" class="items-list">
                      <div v-for="(item, itemIdx) in expense.items" :key="itemIdx" class="item-row">
                        <span class="item-info">
                          <span class="item-name">{{ item.name }}</span>
                          <span v-if="item.tag" :class="['item-tag', 'item-tag--' + item.tag.replace(/\s+/g, '-').toLowerCase()]">{{ item.tag }}</span>
                          <span v-else class="item-no-tag">Kein Tag</span>
                        </span>
                        <span class="item-price">{{ Number(item.price).toFixed(2) }} ‚Ç¨</span>
                      </div>
                    </div>
                    <p v-else class="no-data">Keine Einzelposten erfasst</p>
                  </div>
                </div>
                
              </div>
            </div>
          </div>
          <div v-if="validExpenses.length" class="total-expenses-row">
            <b>Gesamtausgaben: {{ validExpenses.reduce((sum, exp) => sum + getExpenseTotal(exp), 0).toFixed(2) }} ‚Ç¨</b>
          </div>
          <p v-else style="color:#888;">Noch keine Ausgaben erfasst.</p>
          


          <!-- Best√§tigungsmodal f√ºr fehlende Tags -->
          <div v-if="showExpenseMissingTagsModal" class="modal-overlay modal-overlay--top">
            <div class="modal-dialog" style="max-width:450px;">
              <h2 style="text-align:center; margin-bottom:1.5em;">‚ö†Ô∏è Fehlende Tags</h2>
              <p style="text-align:center; margin-bottom:2em; color:#555; line-height:1.5;">
                Nicht alle Einzelposten haben einen Tag.<br/>
                Trotzdem speichern?
              </p>
              <div style="display:flex; justify-content:center; gap:1em;">
                <button @click="confirmSaveExpenseWithMissingTags" 
                        style="padding:0.8em 1.5em; background:#ff9800; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">
                  Ja, trotzdem speichern
                </button>
                <button @click="cancelSaveExpenseWithMissingTags" 
                        style="padding:0.8em 1.5em; background:#9e9e9e; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">
                  Nein, zur√ºck
                </button>
              </div>
            </div>
          </div>
          <!-- Modal f√ºr neues Event / Gruppenveranstaltung -->
          <div v-if="showEventModal" class="modal-overlay">
            <div class="modal-dialog" style="max-width:600px;">
              <h2 style="text-align:center; margin-bottom:1.5em;">üéâ Event / Gruppenveranstaltung</h2>
              
              <div style="display:grid; grid-template-columns:2fr 1fr; gap:1em; margin-bottom:1.5em;">
                <input v-model="newEventName" 
                       placeholder="Eventname (z.B. Bowling)" 
                       style="padding:0.8em; border:1px solid #e0e0e0; border-radius:8px; font-size:1em;" />
                <input v-model.number="newEventPrice" 
                       type="number" 
                       min="0.01" 
                       step="0.01" 
                       placeholder="Eventpreis (‚Ç¨)" 
                       style="padding:0.8em; border:1px solid #e0e0e0; border-radius:8px; font-size:1em;" />
              </div>
              
              <div style="margin-bottom:1.5em;">
                <h3 style="margin-bottom:0.8em; color:#333;">üë• Teilnehmer</h3>
                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:0.8em;">
                  <label v-for="user in users" :key="user.name" 
                         style="display:flex; align-items:center; padding:0.5em; background:#f8f9fa; border-radius:6px; cursor:pointer;">
                    <input type="checkbox" 
                           :value="user.name" 
                           :checked="newEventParticipants.includes(user.name)" 
                           @change="toggleEventParticipant(user.name)"
                           style="margin-right:0.5em; cursor:pointer;" />
                    <span style="font-weight:500;">{{ user.name }}</span>
                  </label>
                </div>
              </div>
              
              <div style="margin-bottom:1.5em;">
                <h3 style="margin-bottom:0.8em; color:#333;">üí∞ Extra Ausgaben</h3>
                <div v-for="(extra, idx) in newEventExtras" :key="idx" 
                     style="display:grid; grid-template-columns:2fr 1fr 2fr auto; gap:0.5em; align-items:center; margin-bottom:0.5em;">
                  <input v-model="extra.label" 
                         placeholder="Bezeichnung (z.B. Getr√§nke)" 
                         style="padding:0.5em; border:1px solid #e0e0e0; border-radius:6px;" />
                  <input v-model.number="extra.price" 
                         type="number" 
                         min="0.01" 
                         step="0.01" 
                         placeholder="Preis (‚Ç¨)" 
                         style="padding:0.5em; border:1px solid #e0e0e0; border-radius:6px;" />
                  <div class="dropdown-multiselect" @click.stop="toggleExtraDropdown(idx)" 
                       style="background:#f8f9fa; padding:0.5em; border-radius:6px; cursor:pointer; position:relative;">
                    <div class="dropdown-label">
                      Personen: {{ extra.participants.length }}
                      <span class="dropdown-arrow">‚ñº</span>
                    </div>
                    <div v-if="showExtraDropdown === idx" class="dropdown-list" @click.stop>
                      <label v-for="user in users" :key="user.name" style="display:block; font-weight:normal;">
                        <input type="checkbox" :value="user.name" :checked="extra.participants.includes(user.name)" @change="toggleExtraParticipant(idx, user.name)">
                        {{ user.name }}
                      </label>
                    </div>
                  </div>
                  <button type="button" @click="removeEventExtra(idx)" 
                          style="padding:0.5em 0.8em; background:#f44336; color:white; border:none; border-radius:6px; cursor:pointer;">√ó</button>
                </div>
                <button type="button" @click="addEventExtra" 
                        style="padding:0.6em 1.2em; background:#2196f3; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:500;">+ Extra hinzuf√ºgen</button>
              </div>
              
              <div style="display:flex; justify-content:center; gap:1em; margin-top:2em;">
                <button @click="saveEvent" 
                        style="padding:0.8em 2.5em; background:#4caf50; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; font-size:1em;">
                  Speichern
                </button>
                <button @click="closeEventModal" 
                        style="padding:0.8em 2.5em; background:#f44336; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; font-size:1em;">
                  Abbrechen
                </button>
              </div>
            </div>
          </div>
          <!-- Modal zum Hinzuf√ºgen einer neuen Sammelausgabe -->
          <div v-if="showExpenseModal" class="modal-overlay">
            <div class="modal-dialog" style="max-width:900px;" @click.stop="closeDropdownOnModalClick">
              <h2 style="text-align:center; margin-bottom:1.5em;">üõí Sammelausgabe</h2>
              
              <div style="margin-bottom:1.5em;">
                <input v-model="newExpenseName" 

                       placeholder="Name der Sammelausgabe (z.B. Supermarkt-Einkauf)" 
                       style="width:100%; padding:0.8em; border:1px solid #e0e0e0; border-radius:8px; font-size:1.1em; text-align:center;" />
              </div>
              
              <div style="margin-bottom:1.5em;">
                <h3 style="margin-bottom:0.8em; color:#333;">üìã Einzelposten</h3>
                <div style="max-height:300px; overflow-y:auto; padding-right:0.5em;">
                  <div v-for="(item, idx) in newExpenseItems" :key="idx" 
                       style="display:grid; grid-template-columns:auto 2.5fr 100px 1.5fr auto; gap:0.5em; align-items:center; margin-bottom:0.5em;">
                    <span v-if="missingTagsInExpenseItems.includes(idx)" 
                          style="color:#f44336; font-weight:bold; font-size:1.2em; width:20px; text-align:center;"
                          title="Tag fehlt">‚ö†</span>
                    <span v-else style="width:20px;"></span>
                    <input v-model="item.name" 
                           placeholder="Artikel (z.B. Brot)" 
                           style="padding:0.6em; border:1px solid #e0e0e0; border-radius:6px;" />
                    <input v-model.number="item.price" 
                           type="number" 
                           min="0.01" 
                           step="0.01" 
                           placeholder="Preis" 
                           style="padding:0.6em; border:1px solid #e0e0e0; border-radius:6px; text-align:right;" />
                    <div class="dropdown-multiselect" style="position:relative;">
  <div 
    class="dropdown-label" 
    @click.stop="toggleItemTagDropdown(idx)" 
    style="padding:0.6em; border:1px solid #e0e0e0; border-radius:6px; background:white; cursor:pointer; min-height:38px; display:flex; align-items:center;"
  >
    <span v-if="!item.tag" style="color:#666;">Kein Tag</span>
    <span v-else :class="'tag-badge tag-badge--' + item.tag.toLowerCase().replace(/ /g, '-')" style="margin:0;">{{ item.tag }}</span>
    <span class="dropdown-arrow" style="position:absolute; right:10px;">‚ñº</span>
  </div>
  
  <!-- Kein lokales Dropdown, wir nutzen das Portal -->
</div>
                    <button type="button" @click="removeExpenseItem(idx)" 
                            style="padding:0.5em 0.8em; background:#f44336; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold;">√ó</button>
                  </div>
                </div>
                <button type="button" @click="addExpenseItem" 
                        style="margin-top:0.8em; padding:0.6em 1.2em; background:#2196f3; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:500;">+ Einzelposten hinzuf√ºgen</button>
              </div>
              
              <div v-if="expenseError" 
                   style="padding:0.8em; background:#ffebee; border:1px solid #ffcdd2; border-radius:6px; color:#c62828; margin-bottom:1em;">
                {{ expenseError }}
              </div>
              
              <div style="display:flex; justify-content:center; gap:1em; margin-top:2em;">
                <button @click="saveExpense" 
                        style="padding:0.8em 2.5em; background:#4caf50; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; font-size:1em;">
                  Speichern
                </button>
                <button @click="closeExpenseModal" 
                        style="padding:0.8em 2.5em; background:#f44336; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; font-size:1em;">
                  Abbrechen
                </button>
              </div>
              
              <!-- Dropdown Portal f√ºr Tags innerhalb des Modals -->
              <div v-if="showItemTagDropdown !== null" 
                   class="dropdown-list" 
                   :style="'position:fixed; left:' + dropdownPortalCoords.left + 'px; top:' + dropdownPortalCoords.top + 'px; width:180px; z-index:10000; background:white; border:1px solid #e0e0e0; border-radius:6px; margin-top:2px; box-shadow:0 2px 8px rgba(0,0,0,0.1); max-height:250px; overflow-y:auto;'"
                   @click.stop>
                <div v-for="tag in availableExpenseTags" :key="tag" @click="selectItemTag(showItemTagDropdown, tag)" 
                     style="padding:0.8em; cursor:pointer; border-bottom:1px solid #f0f0f0;" 
                     :style="newExpenseItems[showItemTagDropdown]?.tag === tag ? 'background:#f0f0f0;' : ''">
                  <span :class="'tag-badge tag-badge--' + tag.toLowerCase().replace(/ /g, '-')" style="margin:0;">{{ tag }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Delete Expense Modal -->
          <div v-if="showDeleteExpenseModal" class="modal-overlay">
            <div class="modal-dialog" style="max-width:450px;">
              <h2 style="text-align:center; margin-bottom:1.5em;">‚ö†Ô∏è L√∂schen best√§tigen</h2>
              <p style="text-align:center; margin-bottom:2em; color:#555; line-height:1.5;">
                M√∂chtest du die Sammelausgabe<br/>
                <strong style="color:#333;">"{{ expenseToDeleteName }}"</strong><br/>
                wirklich l√∂schen?
              </p>
              <div style="display:flex; justify-content:center; gap:1em;">
                <button @click="deleteExpense" 
                        style="padding:0.8em 2em; background:#f44336; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">
                  Ja, l√∂schen
                </button>
                <button @click="cancelDeleteExpense" 
                        style="padding:0.8em 2em; background:#9e9e9e; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer;">
                  Abbrechen
                </button>
              </div>
            </div>
          </div>
          

        </section>
        <section v-if="currentView === 'trips'">
          <h1>Reisen</h1>
          <p>Hier k√∂nnen sp√§ter Reisen/Projekte verwaltet werden.</p>
        </section>
        <section v-if="currentView === 'settings'">
          <h1>Einstellungen</h1>
          <p>Hier k√∂nnen sp√§ter Einstellungen vorgenommen werden.</p>
        </section>
      </main>
    </div>

    <!-- Edit Modal -->
    <div v-if="showEditModal" class="modal-overlay">
      <div class="modal-dialog">
        <h2>
          <input v-model="editUserName" style="font-size:1.2em; text-align:center; border:none; border-bottom:1px solid #ccc; background:transparent; width:90%;" />
        </h2>
        <div style="margin:1em 0;">
          <div v-for="tag in availableUserTags" :key="tag" style="display:inline-block; margin:0 0.5em 0.5em 0;">
            <label>
              <input type="checkbox" :value="tag" v-model="editUserTags" />
              <span :class="['tag-badge', 'tag-badge--' + tag.replace(/\s+/g, '-').toLowerCase()]">{{ tag }}</span>
            </label>
          </div>
        </div>
        <button @click="saveEditUser">Speichern</button>
        <button @click="cancelEditUser">Abbrechen</button>
        <span style="color:red" v-if="error">{{ error }}</span>
      </div>
    </div>

    <!-- Delete Modal -->
    <div v-if="showDeleteModal" class="modal-overlay">
      <div class="modal-dialog">
        <p>M√∂chtest du den Benutzer "{{ userToDelete }}" wirklich l√∂schen?</p>
        <button @click="confirmDelete">Ja, l√∂schen</button>
        <button @click="cancelDelete">Abbrechen</button>
      </div>
    </div>

    <!-- MODAL F√úR √úBERNACHTUNGSKOSTEN -->
    <div v-if="showAccommodationModal" class="modal-overlay">
          <div class="modal-dialog" style="max-width:600px;">
            <h2 style="text-align:center; margin-bottom:1.5em;">üè® √úbernachtungskosten</h2>
            
            <div style="display:grid; grid-template-columns:2fr 1fr; gap:1em; margin-bottom:1.5em;">
              <input v-model="newAccommodationName" 
                     placeholder="Name der Unterkunft (z.B. Hotel Berlin)" 
                     style="padding:0.8em; border:1px solid #e0e0e0; border-radius:8px; font-size:1em;" />
              <input v-model.number="newAccommodationPricePerNight" 
                     type="number" 
                     min="0.01" 
                     step="0.01" 
                     placeholder="Preis pro Nacht (‚Ç¨)" 
                     style="padding:0.8em; border:1px solid #e0e0e0; border-radius:8px; font-size:1em;" />
            </div>
            
            <div style="margin-bottom:1.5em;">
              <h3 style="margin-bottom:0.8em; color:#333;">üë• Teilnehmer</h3>
              <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr)); gap:0.8em;">
                <div v-for="user in users" :key="user.name" 
                     style="display:flex; align-items:center; justify-content:space-between; padding:0.8em; background:#f8f9fa; border-radius:6px;">
                  <label style="display:flex; align-items:center; cursor:pointer; flex:1;">
                    <input type="checkbox" 
                           :value="user.name" 
                           v-model="accommodationParticipants" 
                           @change="toggleAccommodationParticipant(user.name)"
                           style="margin-right:0.5em; cursor:pointer;" />
                    <span style="font-weight:500;">{{ user.name }}</span>
                  </label>
                  <input v-if="accommodationParticipants.includes(user.name)"
                         v-model.number="accommodationNights[user.name]" 
                         type="number" 
                         min="1" 
                         placeholder="1" 
                         style="width:60px; padding:0.5em; border:1px solid #e0e0e0; border-radius:6px; text-align:center; margin-left:1em;" />
                </div>
              </div>
            </div>
            
            <div style="margin-bottom:1.5em;">
              <h3 style="margin-bottom:0.8em; color:#333;">üéØ Extras</h3>
              <div style="display:flex; gap:0.5em; margin-bottom:0.8em;">
                <input v-model="newAccommodationExtraLabel" 
                       placeholder="Bezeichnung (z.B. Fr√ºhst√ºck)" 
                       style="flex:1; padding:0.5em; border:1px solid #e0e0e0; border-radius:6px;" />
                <input v-model.number="newAccommodationExtraPrice" 
                       type="number" 
                       min="0.01" 
                       step="0.01" 
                       placeholder="Preis (‚Ç¨)" 
                       style="width:120px; padding:0.5em; border:1px solid #e0e0e0; border-radius:6px;" />
                <button @click="addAccommodationExtra" 
                        style="padding:0.5em 1em; background:#4caf50; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:500;">
                  Hinzuf√ºgen
                </button>
              </div>
              <div v-if="accommodationExtras.length" style="display:flex; flex-direction:column; gap:0.5em;">
                <div v-for="(extra, idx) in accommodationExtras" :key="idx" 
                     style="display:flex; justify-content:space-between; align-items:center; padding:0.8em; background:#f8f9fa; border-radius:6px;">
                  <span style="font-weight:500;">{{ extra.label }}</span>
                  <div style="display:flex; align-items:center; gap:0.5em;">
                    <span style="color:#2e7d32; font-weight:600;">{{ extra.price.toFixed(2) }} ‚Ç¨</span>
                    <button @click="removeAccommodationExtra(idx)" 
                            style="padding:0.3em 0.6em; background:#f44336; color:white; border:none; border-radius:4px; cursor:pointer;">√ó</button>
                  </div>
                </div>
              </div>
            </div>
            
            <div style="display:flex; gap:1em; justify-content:center; margin-top:2em;">
              <button @click="saveAccommodation" 
                      style="padding:0.8em 2.5em; background:#4caf50; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; font-size:1em;">
                Speichern
              </button>
              <button @click="closeAccommodationModal" 
                      style="padding:0.8em 2.5em; background:#f44336; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; font-size:1em;">
                Abbrechen
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
    <script src="js/data-manager.js"></script>
    <script src="js/calculator.js"></script>
    <script src="js/app.js"></script>
  </body>
</html>
